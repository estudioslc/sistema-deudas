<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema LC - Consulta y Edici√≥n</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .nav a { padding: 10px 20px; text-decoration: none; color: #333; background: #e0e0e0; border-radius: 5px; transition: all 0.3s; }
        .nav a:hover { background: #007bff; color: white; }
        .nav a.active { background: #007bff; color: white; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; margin: 0 0 10px 0; }
        
        /* B√∫squeda */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box input { flex: 1; min-width: 300px; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        .search-box input:focus { outline: none; border-color: #007bff; }
        .search-box button { padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .search-box button:hover { background: #0056b3; }
        
        /* Filtros */
        .filtros { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .filtro-btn { padding: 8px 16px; border: 2px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .filtro-btn:hover { border-color: #007bff; }
        .filtro-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .filtro-btn.todos { background: #6c757d; color: white; border-color: #6c757d; }
        
        /* Tabla de resultados */
        .resultados { margin-top: 20px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; font-size: 13px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; font-weight: bold; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e3f2fd; }
        
        /* Celdas editables */
        .editable { 
            background: #fff3cd; 
            border: 1px dashed #ffc107; 
            padding: 5px; 
            cursor: pointer; 
            min-width: 100px;
            border-radius: 3px;
        }
        .editable:hover { background: #ffeaa7; }
        .editable-input { 
            width: 100%; 
            padding: 5px; 
            border: 2px solid #007bff; 
            border-radius: 3px;
            font-size: 13px;
        }
        
        /* Badges de estado */
        .estado-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        .estado-X { background: #ffc107; color: #000; }
        .estado-D { background: #dc3545; color: #fff; }
        .estado-S { background: #6f42c1; color: #fff; }
        .estado-E { background: #fd7e14; color: #fff; }
        .estado-C { background: #20c997; color: #fff; }
        .estado-P { background: #28a745; color: #fff; }
        
        /* Botones de acci√≥n */
        .btn-accion { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px; }
        .btn-guardar { background: #28a745; color: white; }
        .btn-guardar:hover { background: #218838; }
        .btn-cancelar { background: #6c757d; color: white; }
        .btn-cancelar:hover { background: #545b62; }
        .btn-detalle { background: #17a2b8; color: white; }
        .btn-detalle:hover { background: #138496; }
        
        /* Modal de detalle */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; margin: 30px auto; padding: 30px; max-width: 900px; border-radius: 10px; position: relative; }
        .cerrar { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #999; }
        .cerrar:hover { color: #333; }
        
        .detalle-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .detalle-item { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .detalle-label { font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        .detalle-valor { font-size: 14px; color: #333; word-break: break-word; }
        .detalle-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; }
        .detalle-input:focus { border-color: #007bff; outline: none; }
        
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; font-size: 14px; color: #666; }
        .stat-item { background: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .no-resultados { text-align: center; padding: 40px; color: #666; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .success-msg { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 2000; }
        .error-msg { background: #dc3545; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Consulta y Edici√≥n de Causas</h1>
        <p style="color: #666;">Busc√° y edit√° cualquier campo. Los cambios se guardan autom√°ticamente en la base de datos.</p>
        <div class="nav">
            <a href="index.html">üè† Inicio</a>
            <a href="carga.html">üì§ Carga Masiva</a>
            <a href="consulta.html" class="active">üîç Consulta y Edici√≥n</a>
            <a href="admin.html">‚öôÔ∏è Administraci√≥n</a>
        </div>
    </div>

    <div class="card">
        <div class="search-box">
            <input type="text" id="busquedaInput" placeholder="Buscar por causa (AUT/123/2024), CUIT, titular, expediente, car√°tula..." />
            <button onclick="realizarBusqueda()">üîç Buscar</button>
            <button onclick="cargarTodas()" style="background: #6c757d;">üìã Ver Todas</button>
        </div>
        
        <div class="filtros">
            <button class="filtro-btn todos active" onclick="filtrarPorEstado('todos')">Todos</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('X')">Extrajudicial (X)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('D')">Con Demanda (D)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('S')">Con Sentencia (S)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('E')">Ejecuci√≥n (E)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('C')">Con Convenio (C)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('P')">Pagadas (P)</button>
        </div>
        
        <div class="stats-bar" id="statsBar"></div>
        
        <div class="resultados" id="resultados">
            <div class="no-resultados">
                <h3>üëã Bienvenido al sistema de consulta</h3>
                <p>Escrib√≠ un t√©rmino de b√∫squeda o hac√© click en "Ver Todas" para ver todas las causas.<br>
                Pod√©s editar cualquier campo haciendo click sobre √©l.</p>
            </div>
        </div>
    </div>

    <!-- Modal de edici√≥n completa -->
    <div class="modal" id="modalEdicion">
        <div class="modal-content">
            <span class="cerrar" onclick="cerrarModal()">&times;</span>
            <h2>‚úèÔ∏è Editar Causa Completa</h2>
            <div id="formularioEdicion"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
                <button class="btn-guardar" onclick="guardarEdicionCompleta()">üíæ Guardar Todos los Cambios</button>
            </div>
        </div>
    </div>

    <div class="success-msg" id="successMsg">‚úì Cambios guardados</div>

    <script>
        const SUPABASE_URL = 'https://jigyfagcxaifgdogaduf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppZ3lmYWdjeGFpZmdkb2dhZHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTQ1NDcsImV4cCI6MjA4NzA3MDU0N30.zreu5LPBTgmITGiAGrwEAky6RvIaXjFr3E6sXcK0Olw';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let causasActuales = [];
        let estadoFiltroActual = 'todos';
        let causaEditando = null;
        
        const nombresEstado = {
            'X': 'Extrajudicial',
            'D': 'Con Demanda',
            'S': 'Con Sentencia',
            'E': 'Ejecuci√≥n de Sentencia',
            'C': 'Con Convenio',
            'P': 'Pagada'
        };
        
        const camposEditables = [
            { campo: 'caratula', label: 'Car√°tula', tipo: 'text' },
            { campo: 'cuit', label: 'CUIT', tipo: 'text' },
            { campo: 'titular', label: 'Titular', tipo: 'text' },
            { campo: 'telefono', label: 'Tel√©fono', tipo: 'text' },
            { campo: 'mail', label: 'Email', tipo: 'email' },
            { campo: 'expediente', label: 'Expediente', tipo: 'text' },
            { campo: 'estado', label: 'Estado', tipo: 'select', opciones: ['X', 'D', 'S', 'E', 'C', 'P'] },
            { campo: 'domicilio_postal', label: 'Domicilio Postal', tipo: 'text' },
            { campo: 'obs', label: 'Observaciones', tipo: 'textarea' },
            { campo: 'notas_seguimiento', label: 'Notas de Seguimiento', tipo: 'textarea' }
        ];
        
        // ==========================================
        // B√öSQUEDA
        // ==========================================
        
        async function realizarBusqueda() {
            const termino = document.getElementById('busquedaInput').value.trim();
            if (!termino) {
                mostrarError('Ingres√° un t√©rmino de b√∫squeda');
                return;
            }
            await buscarEnSupabase(termino);
        }
        
        async function cargarTodas() {
            await buscarEnSupabase('');
        }
        
        async function buscarEnSupabase(termino) {
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = '<div class="no-resultados"><div class="loading"></div> Cargando...</div>';
            
            try {
                let query = supabaseClient.from('deudas').select('*');
                
                if (termino) {
                    query = query.or(`causa.ilike.%${termino}%,titular.ilike.%${termino}%,cuit.ilike.%${termino}%,expediente.ilike.%${termino}%,caratula.ilike.%${termino}%`);
                }
                
                if (estadoFiltroActual !== 'todos') {
                    query = query.eq('estado', estadoFiltroActual);
                }
                
                query = query.order('created_at', { ascending: false }).limit(200);
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                causasActuales = data || [];
                mostrarResultadosTabla(causasActuales);
                actualizarStats(causasActuales);
                
            } catch (err) {
                resultadosDiv.innerHTML = `<div class="no-resultados">‚ùå Error: ${err.message}</div>`;
            }
        }
        
        function filtrarPorEstado(estado) {
            estadoFiltroActual = estado;
            document.querySelectorAll('.filtro-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const termino = document.getElementById('busquedaInput').value.trim();
            buscarEnSupabase(termino);
        }
        
        // ==========================================
        // MOSTRAR RESULTADOS EN TABLA EDITABLE
        // ==========================================
        
        function mostrarResultadosTabla(causas) {
            const resultadosDiv = document.getElementById('resultados');
            
            if (causas.length === 0) {
                resultadosDiv.innerHTML = '<div class="no-resultados">üòï No se encontraron causas</div>';
                return;
            }
            
            let html = `<table>
                <thead>
                    <tr>
                        <th>Causa</th>
                        <th>Car√°tula</th>
                        <th>CUIT</th>
                        <th>Titular</th>
                        <th>Tel√©fono</th>
                        <th>Email</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>`;
            
            causas.forEach(causa => {
                const estadoClass = causa.estado ? `estado-${causa.estado}` : '';
                const estadoNombre = nombresEstado[causa.estado] || causa.estado || 'Sin';
                
                html += `<tr>
                    <td><strong>${causa.causa || '-'}</strong></td>
                    <td class="editable" onclick="editarCelda(${causa.id}, 'caratula', '${escapeHtml(causa.caratula || '')}')">${causa.caratula || '-'}</td>
                    <td class="editable" onclick="editarCelda(${causa.id}, 'cuit', '${escapeHtml(causa.cuit || '')}')">${causa.cuit || '-'}</td>
                    <td class="editable" onclick="editarCelda(${causa.id}, 'titular', '${escapeHtml(causa.titular || '')}')">${causa.titular || '-'}</td>
                    <td class="editable" onclick="editarCelda(${causa.id}, 'telefono', '${escapeHtml(causa.telefono || '')}')">${causa.telefono || '-'}</td>
                    <td class="editable" onclick="editarCelda(${causa.id}, 'mail', '${escapeHtml(causa.mail || '')}')">${causa.mail || '-'}</td>
                    <td><span class="estado-badge ${estadoClass}" onclick="cambiarEstado(${causa.id}, '${causa.estado}')">${estadoNombre}</span></td>
                    <td>
                        <button class="btn-accion btn-detalle" onclick="abrirEdicionCompleta(${causa.id})">‚úèÔ∏è Editar Todo</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultadosDiv.innerHTML = html;
        }
        
        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        // ==========================================
        // EDICI√ìN INLINE DE CELDAS
        // ==========================================
        
        async function editarCelda(id, campo, valorActual) {
            const nuevoValor = prompt(`Editar ${campo}:`, valorActual);
            if (nuevoValor === null) return; // Cancel√≥
            
            try {
                const { error } = await supabaseClient
                    .from('deudas')
                    .update({ 
                        [campo]: nuevoValor,
                        fecha_ultima_actualizacion: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarSuccess(`‚úì ${campo} actualizado`);
                
                // Recargar solo si estamos viendo todas
                const termino = document.getElementById('busquedaInput').value.trim();
                await buscarEnSupabase(termino);
                
            } catch (err) {
                alert('‚ùå Error al guardar: ' + err.message);
            }
        }
        
        async function cambiarEstado(id, estadoActual) {
            const estados = ['X', 'D', 'S', 'E', 'C', 'P'];
            const opciones = estados.map(e => `${e} = ${nombresEstado[e]}`).join('\n');
            const nuevoEstado = prompt(`Estado actual: ${estadoActual}\n\nNuevo estado:\n${opciones}`, estadoActual);
            
            if (!nuevoEstado || !estados.includes(nuevoEstado)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('deudas')
                    .update({ 
                        estado: nuevoEstado,
                        fecha_ultima_actualizacion: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarSuccess('‚úì Estado actualizado');
                
                const termino = document.getElementById('busquedaInput').value.trim();
                await buscarEnSupabase(termino);
                
            } catch (err) {
                alert('‚ùå Error: ' + err.message);
            }
        }
        
        // ==========================================
        // EDICI√ìN COMPLETA (MODAL)
        // ==========================================
        
        async function abrirEdicionCompleta(id) {
            causaEditando = causasActuales.find(c => c.id === id);
            if (!causaEditando) return;
            
            const modal = document.getElementById('modalEdicion');
            const formulario = document.getElementById('formularioEdicion');
            
            let html = '<div class="detalle-grid">';
            
            camposEditables.forEach(campo => {
                const valor = causaEditando[campo.campo] || '';
                
                html += `<div class="detalle-item">
                    <div class="detalle-label">${campo.label}</div>`;
                
                if (campo.tipo === 'select') {
                    html += `<select class="detalle-input" id="edit_${campo.campo}">
                        ${campo.opciones.map(op => `<option value="${op}" ${valor === op ? 'selected' : ''}>${op} - ${nombresEstado[op]}</option>`).join('')}
                    </select>`;
                } else if (campo.tipo === 'textarea') {
                    html += `<textarea class="detalle-input" id="edit_${campo.campo}" rows="3">${valor}</textarea>`;
                } else {
                    html += `<input type="${campo.tipo}" class="detalle-input" id="edit_${campo.campo}" value="${valor}">`;
                }
                
                html += '</div>';
            });
            
            // Campos de solo lectura
            html += `<div class="detalle-item" style="background: #e9ecef;">
                <div class="detalle-label">Causa (no editable)</div>
                <div class="detalle-valor">${causaEditando.causa || '-'}</div>
            </div>`;
            
            html += `<div class="detalle-item" style="background: #e9ecef;">
                <div class="detalle-label">Jud ID (no editable)</div>
                <div class="detalle-valor">${causaEditando.jud_id || '-'}</div>
            </div>`;
            
            html += '</div>';
            
            formulario.innerHTML = html;
            modal.style.display = 'block';
        }
        
        async function guardarEdicionCompleta() {
            if (!causaEditando) return;
            
            const cambios = {};
            camposEditables.forEach(campo => {
                const elemento = document.getElementById(`edit_${campo.campo}`);
                if (elemento) {
                    cambios[campo.campo] = elemento.value;
                }
            });
            cambios.fecha_ultima_actualizacion = new Date().toISOString();
            
            try {
                const { error } = await supabaseClient
                    .from('deudas')
                    .update(cambios)
                    .eq('id', causaEditando.id);
                
                if (error) throw error;
                
                mostrarSuccess('‚úì Todos los cambios guardados');
                cerrarModal();
                
                const termino = document.getElementById('busquedaInput').value.trim();
                await buscarEnSupabase(termino);
                
            } catch (err) {
                alert('‚ùå Error al guardar: ' + err.message);
            }
        }
        
        function cerrarModal() {
            document.getElementById('modalEdicion').style.display = 'none';
            causaEditando = null;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function actualizarStats(causas) {
            const statsBar = document.getElementById('statsBar');
            const porEstado = {};
            causas.forEach(c => {
                porEstado[c.estado || 'Sin'] = (porEstado[c.estado || 'Sin'] || 0) + 1;
            });
            
            let html = `<div class="stat-item"><strong>Mostrando:</strong> ${causas.length}</div>`;
            Object.keys(porEstado).sort().forEach(est => {
                html += `<div class="stat-item">${nombresEstado[est] || est}: ${porEstado[est]}</div>`;
            });
            
            statsBar.innerHTML = html;
        }
        
        function mostrarSuccess(mensaje) {
            const msg = document.getElementById('successMsg');
            msg.textContent = mensaje;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }
        
        function mostrarError(mensaje) {
            const msg = document.getElementById('successMsg');
            msg.textContent = mensaje;
            msg.classList.add('error-msg');
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
                msg.classList.remove('error-msg');
            }, 3000);
        }
        
        // Event listeners
        document.getElementById('busquedaInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') realizarBusqueda();
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('modalEdicion');
            if (event.target === modal) cerrarModal();
        }
    </script>
</body>
</html>
