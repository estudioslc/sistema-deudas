<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema LC - Consulta de Causas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .nav a { padding: 10px 20px; text-decoration: none; color: #333; background: #e0e0e0; border-radius: 5px; transition: all 0.3s; }
        .nav a:hover { background: #007bff; color: white; }
        .nav a.active { background: #007bff; color: white; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; margin: 0 0 10px 0; }
        
        /* B√∫squeda */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box input { flex: 1; min-width: 300px; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; }
        .search-box input:focus { outline: none; border-color: #007bff; }
        .search-box button { padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .search-box button:hover { background: #0056b3; }
        
        /* Filtros */
        .filtros { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .filtro-btn { padding: 8px 16px; border: 2px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .filtro-btn:hover { border-color: #007bff; }
        .filtro-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .filtro-btn.todos { background: #6c757d; color: white; border-color: #6c757d; }
        .filtro-btn.baja { background: #495057; color: white; border-color: #495057; }
        
        /* Tabla de resultados */
        .resultados { margin-top: 20px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; font-size: 13px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; font-weight: bold; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #e3f2fd; }
        
        /* Badges de estado */
        .estado-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .estado-X { background: #ffc107; color: #000; }
        .estado-D { background: #dc3545; color: #fff; }
        .estado-S { background: #6f42c1; color: #fff; }
        .estado-E { background: #fd7e14; color: #fff; }
        .estado-C { background: #20c997; color: #fff; }
        .estado-P { background: #28a745; color: #fff; }
        .estado-B { background: #6c757d; color: #fff; }
        
        /* Botones de acci√≥n */
        .btn-accion { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px; }
        .btn-editar { background: #ffc107; color: #000; }
        .btn-editar:hover { background: #e0a800; }
        .btn-ver { background: #17a2b8; color: white; }
        .btn-ver:hover { background: #138496; }
        
        /* Modal de edici√≥n */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; margin: 30px auto; padding: 30px; max-width: 900px; border-radius: 10px; position: relative; }
        .cerrar { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #999; }
        .cerrar:hover { color: #333; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .form-group { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .form-group label { display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            border-color: #007bff; outline: none; 
        }
        .form-group textarea { resize: vertical; min-height: 60px; }
        
        .form-actions { margin-top: 20px; text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-guardar { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-guardar:hover { background: #218838; }
        .btn-cancelar { background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-cancelar:hover { background: #545b62; }
        
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; font-size: 14px; color: #666; }
        .stat-item { background: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .no-resultados { text-align: center; padding: 40px; color: #666; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .success-msg { position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 2000; }
        .error-msg { background: #dc3545; }
        
        .modo-indicador { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-left: 10px; }
        .modo-consulta { background: #e3f2fd; color: #1976d2; }
        .modo-edicion { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Consulta de Causas <span class="modo-indicador modo-consulta">MODO CONSULTA</span></h1>
        <p style="color: #666;">Busc√° causas y hac√© click en "Editar" para modificar los datos</p>
        <div class="nav">
            <a href="index.html">üè† Inicio</a>
            <a href="carga.html">üì§ Carga Masiva</a>
            <a href="consulta.html" class="active">üîç Consulta</a>
            <a href="admin.html">‚öôÔ∏è Administraci√≥n</a>
        </div>
    </div>

    <div class="card">
        <div class="search-box">
            <input type="text" id="busquedaInput" placeholder="Buscar por causa (AUT/123/2024), CUIT, titular, expediente, car√°tula..." />
            <button onclick="realizarBusqueda()">üîç Buscar</button>
            <button onclick="cargarTodas()" style="background: #6c757d;">üìã Ver Todas</button>
        </div>
        
        <div class="filtros" id="filtrosContainer">
            <button class="filtro-btn todos active" onclick="filtrarPorEstado('todos')">Todos</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('X')">Extrajudicial (X)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('D')">Con Demanda (D)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('S')">Con Sentencia (S)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('E')">Ejecuci√≥n (E)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('C')">Con Convenio (C)</button>
            <button class="filtro-btn" onclick="filtrarPorEstado('P')">Pagadas (P)</button>
            <button class="filtro-btn baja" onclick="filtrarPorEstado('B')">Bajas (B)</button>
        </div>
        
        <div class="stats-bar" id="statsBar"></div>
        
        <div class="resultados" id="resultados">
            <div class="no-resultados">
                <h3>üëã Bienvenido al sistema de consulta</h3>
                <p>Escrib√≠ un t√©rmino de b√∫squeda o hac√© click en "Ver Todas" para ver todas las causas.<br>
                Para editar una causa, buscala primero y luego hac√© click en el bot√≥n "Editar".</p>
            </div>
        </div>
    </div>

    <!-- Modal de edici√≥n -->
    <div class="modal" id="modalEdicion">
        <div class="modal-content">
            <span class="cerrar" onclick="cerrarModal()">&times;</span>
            <h2>‚úèÔ∏è Editar Causa <span class="modo-indicador modo-edicion">MODO EDICI√ìN</span></h2>
            <div id="formularioEdicion"></div>
        </div>
    </div>

    <div class="success-msg" id="successMsg">‚úì Cambios guardados</div>

    <script>
        const SUPABASE_URL = 'https://jigyfagcxaifgdogaduf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppZ3lmYWdjeGFpZmdkb2dhZHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTQ1NDcsImV4cCI6MjA4NzA3MDU0N30.zreu5LPBTgmITGiAGrwEAky6RvIaXjFr3E6sXcK0Olw';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let causasActuales = [];
        let estadoFiltroActual = 'todos';
        let causaEditando = null;
        
        const nombresEstado = {
            'X': 'Extrajudicial',
            'D': 'Con Demanda',
            'S': 'Con Sentencia',
            'E': 'Ejecuci√≥n de Sentencia',
            'C': 'Con Convenio',
            'P': 'Pagada',
            'B': 'Baja'
        };

        // Verificar si viene filtro de la URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const filtro = urlParams.get('filtro');
            if (filtro) {
                estadoFiltroActual = filtro;
                // Actualizar bot√≥n activo
                document.querySelectorAll('.filtro-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.includes(filtro) || (filtro === 'todos' && btn.classList.contains('todos'))) {
                        btn.classList.add('active');
                    }
                });
                cargarTodas();
            }
        };
        
        // ==========================================
        // B√öSQUEDA
        // ==========================================
        
        async function realizarBusqueda() {
            const termino = document.getElementById('busquedaInput').value.trim();
            if (!termino) {
                mostrarError('Ingres√° un t√©rmino de b√∫squeda');
                return;
            }
            await buscarEnSupabase(termino);
        }
        
        async function cargarTodas() {
            await buscarEnSupabase('');
        }
        
        async function buscarEnSupabase(termino) {
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = '<div class="no-resultados"><div class="loading"></div> Cargando...</div>';
            
            try {
                let query = supabaseClient.from('deudas').select('*');
                
                if (termino) {
                    query = query.or(`causa.ilike.%${termino}%,titular.ilike.%${termino}%,cuit.ilike.%${termino}%,expediente.ilike.%${termino}%,caratula.ilike.%${termino}%`);
                }
                
                if (estadoFiltroActual !== 'todos') {
                    query = query.eq('estado', estadoFiltroActual);
                }
                
                query = query.order('created_at', { ascending: false }).limit(5000);
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                causasActuales = data || [];
                mostrarResultadosTabla(causasActuales);
                actualizarStats(causasActuales);
                
            } catch (err) {
                resultadosDiv.innerHTML = `<div class="no-resultados">‚ùå Error: ${err.message}</div>`;
            }
        }
        
        function filtrarPorEstado(estado) {
            estadoFiltroActual = estado;
            document.querySelectorAll('.filtro-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const termino = document.getElementById('busquedaInput').value.trim();
            buscarEnSupabase(termino);
        }
        
        // ==========================================
        // MOSTRAR RESULTADOS (SOLO CONSULTA)
        // ==========================================
        
        function mostrarResultadosTabla(causas) {
            const resultadosDiv = document.getElementById('resultados');
            
            if (causas.length === 0) {
                resultadosDiv.innerHTML = '<div class="no-resultados">üòï No se encontraron causas con ese criterio</div>';
                return;
            }
            
            let html = `<table>
                <thead>
                    <tr>
                        <th>Causa</th>
                        <th>Car√°tula</th>
                        <th>CUIT</th>
                        <th>Titular</th>
                        <th>Tel√©fono</th>
                        <th>Email</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>`;
            
            causas.forEach(causa => {
                const estadoClass = causa.estado ? `estado-${causa.estado}` : '';
                const estadoNombre = nombresEstado[causa.estado] || causa.estado || 'Sin';
                
                html += `<tr>
                    <td><strong>${causa.causa || '-'}</strong></td>
                    <td>${causa.caratula || '-'}</td>
                    <td>${causa.cuit || '-'}</td>
                    <td>${causa.titular || '-'}</td>
                    <td>${causa.telefono || '-'}</td>
                    <td>${causa.mail || '-'}</td>
                    <td><span class="estado-badge ${estadoClass}">${estadoNombre}</span></td>
                    <td>
                        <button class="btn-accion btn-ver" onclick="verDetalle(${causa.id})">üëÅÔ∏è Ver</button>
                        <button class="btn-accion btn-editar" onclick="abrirEdicion(${causa.id})">‚úèÔ∏è Editar</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultadosDiv.innerHTML = html;
        }
        
        // ==========================================
        // VER DETALLE (SOLO LECTURA)
        // ==========================================
        
        async function verDetalle(id) {
            const causa = causasActuales.find(c => c.id === id);
            if (!causa) return;
            
            const modal = document.getElementById('modalEdicion');
            const formulario = document.getElementById('formularioEdicion');
            
            const estadoNombre = nombresEstado[causa.estado] || causa.estado || 'Sin';
            const estadoClass = causa.estado ? `estado-${causa.estado}` : '';
            
            let html = `
                <div style="margin-bottom: 20px;">
                    <span class="estado-badge ${estadoClass}" style="font-size: 14px; padding: 8px 16px;">${estadoNombre}</span>
                </div>
                <div class="form-grid" style="pointer-events: none; opacity: 0.8;">
                    <div class="form-group">
                        <label>Causa</label>
                        <input type="text" value="${causa.causa || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Jud ID</label>
                        <input type="text" value="${causa.jud_id || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Expediente</label>
                        <input type="text" value="${causa.expediente || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Car√°tula</label>
                        <input type="text" value="${causa.caratula || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Titular</label>
                        <input type="text" value="${causa.titular || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>CUIT</label>
                        <input type="text" value="${causa.cuit || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" value="${causa.telefono || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" value="${causa.mail || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Domicilio Postal</label>
                        <input type="text" value="${causa.domicilio_postal || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea readonly>${causa.obs || ''}</textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1; background: #fff3cd;">
                        <label>Notas de Seguimiento</label>
                        <textarea readonly>${causa.notas_seguimiento || 'Sin notas'}</textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancelar" onclick="cerrarModal()">Cerrar</button>
                    <button type="button" class="btn-editar" onclick="abrirEdicion(${causa.id})" style="background: #ffc107; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚úèÔ∏è Pasar a Modo Edici√≥n</button>
                </div>
            `;
            
            formulario.innerHTML = html;
            modal.style.display = 'block';
        }
        
        // ==========================================
        // EDICI√ìN
        // ==========================================
        
        async function abrirEdicion(id) {
            causaEditando = causasActuales.find(c => c.id === id);
            if (!causaEditando) return;
            
            const modal = document.getElementById('modalEdicion');
            const formulario = document.getElementById('formularioEdicion');
            
            const estados = ['X', 'D', 'S', 'E', 'C', 'P', 'B'];
            
            let html = `
                <div class="form-grid">
                    <div class="form-group" style="background: #e9ecef;">
                        <label>Causa (no editable)</label>
                        <input type="text" value="${causaEditando.causa || ''}" readonly style="background: #e9ecef;">
                    </div>
                    <div class="form-group" style="background: #e9ecef;">
                        <label>Jud ID (no editable)</label>
                        <input type="text" value="${causaEditando.jud_id || ''}" readonly style="background: #e9ecef;">
                    </div>
                    <div class="form-group">
                        <label>Expediente</label>
                        <input type="text" id="edit_expediente" value="${causaEditando.expediente || ''}">
                    </div>
                    <div class="form-group">
                        <label>Car√°tula</label>
                        <input type="text" id="edit_caratula" value="${causaEditando.caratula || ''}">
                    </div>
                    <div class="form-group">
                        <label>Titular</label>
                        <input type="text" id="edit_titular" value="${causaEditando.titular || ''}">
                    </div>
                    <div class="form-group">
                        <label>CUIT</label>
                        <input type="text" id="edit_cuit" value="${causaEditando.cuit || ''}">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" id="edit_telefono" value="${causaEditando.telefono || ''}">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="edit_mail" value="${causaEditando.mail || ''}">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="edit_estado">
                            ${estados.map(est => `<option value="${est}" ${causaEditando.estado === est ? 'selected' : ''}>${est} - ${nombresEstado[est]}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Domicilio Postal</label>
                        <input type="text" id="edit_domicilio_postal" value="${causaEditando.domicilio_postal || ''}">
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="edit_obs">${causaEditando.obs || ''}</textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1; background: #fff3cd;">
                        <label>Notas de Seguimiento</label>
                        <textarea id="edit_notas_seguimiento">${causaEditando.notas_seguimiento || ''}</textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
                    <button type="button" class="btn-guardar" onclick="guardarEdicion()">üíæ Guardar Cambios</button>
                </div>
            `;
            
            formulario.innerHTML = html;
            modal.style.display = 'block';
        }
        
        async function guardarEdicion() {
            if (!causaEditando) return;
            
            const cambios = {
                expediente: document.getElementById('edit_expediente').value,
                caratula: document.getElementById('edit_caratula').value,
                titular: document.getElementById('edit_titular').value,
                cuit: document.getElementById('edit_cuit').value,
                telefono: document.getElementById('edit_telefono').value,
                mail: document.getElementById('edit_mail').value,
                estado: document.getElementById('edit_estado').value,
                domicilio_postal: document.getElementById('edit_domicilio_postal').value,
                obs: document.getElementById('edit_obs').value,
                notas_seguimiento: document.getElementById('edit_notas_seguimiento').value,
                fecha_ultima_actualizacion: new Date().toISOString()
            };
            
            try {
                const { error } = await supabaseClient
                    .from('deudas')
                    .update(cambios)
                    .eq('id', causaEditando.id);
                
                if (error) throw error;
                
                mostrarSuccess('‚úì Cambios guardados correctamente');
                cerrarModal();
                
                // Recargar tabla
                const termino = document.getElementById('busquedaInput').value.trim();
                await buscarEnSupabase(termino);
                
            } catch (err) {
                alert('‚ùå Error al guardar: ' + err.message);
            }
        }
        
        function cerrarModal() {
            document.getElementById('modalEdicion').style.display = 'none';
            causaEditando = null;
        }
        
        // ==========================================
        // UTILIDADES
        // ==========================================
        
        function actualizarStats(causas) {
            const statsBar = document.getElementById('statsBar');
            const porEstado = {};
            causas.forEach(c => {
                porEstado[c.estado || 'Sin'] = (porEstado[c.estado || 'Sin'] || 0) + 1;
            });
            
            let html = `<div class="stat-item"><strong>Mostrando:</strong> ${causas.length}</div>`;
            Object.keys(porEstado).sort().forEach(est => {
                html += `<div class="stat-item">${nombresEstado[est] || est}: ${porEstado[est]}</div>`;
            });
            
            statsBar.innerHTML = html;
        }
        
        function mostrarSuccess(mensaje) {
            const msg = document.getElementById('successMsg');
            msg.textContent = mensaje;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
        }
        
        function mostrarError(mensaje) {
            const msg = document.getElementById('successMsg');
            msg.textContent = mensaje;
            msg.classList.add('error-msg');
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
                msg.classList.remove('error-msg');
            }, 3000);
        }
        
        // Event listeners
        document.getElementById('busquedaInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') realizarBusqueda();
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('modalEdicion');
            if (event.target === modal) cerrarModal();
        }
    </script>
</body>
</html>
