<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema LC - Carga Masiva</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .nav a { padding: 10px 20px; text-decoration: none; color: #333; background: #e0e0e0; border-radius: 5px; transition: all 0.3s; }
        .nav a:hover { background: #007bff; color: white; }
        .nav a.active { background: #007bff; color: white; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; margin: 0 0 10px 0; }
        .subtitle { color: #666; margin-bottom: 20px; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; cursor: pointer; margin: 10px 5px; border-radius: 5px; font-size: 16px; transition: background 0.3s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        input[type="file"] { padding: 10px; border: 2px dashed #ccc; border-radius: 5px; width: 100%; max-width: 400px; }
        .exito { color: #155724; background: #d4edda; padding: 15px; border-radius: 5px; border: 1px solid #c3e6cb; margin: 10px 0; }
        .error { color: #721c24; background: #f8d7da; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb; margin: 10px 0; }
        .info { color: #856404; background: #fff3cd; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7; margin: 10px 0; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #007bff; }
        .stat-number { font-size: 32px; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; margin-top: 5px; }
        .preview { margin-top: 20px; overflow-x: auto; max-height: 400px; overflow-y: auto; }
        table { border-collapse: collapse; width: 100%; font-size: 12px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; font-weight: bold; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        .columnas-encontradas { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; border-left: 4px solid #007bff; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .estado-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .estado-X { background: #ffc107; color: #000; }
        .estado-D { background: #dc3545; color: #fff; }
        .estado-S { background: #6f42c1; color: #fff; }
        .estado-E { background: #fd7e14; color: #fff; }
        .estado-C { background: #20c997; color: #fff; }
        .estado-P { background: #28a745; color: #fff; }
        .warning-box { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 15px 0; color: #856404; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öñÔ∏è Estudio LC - Sistema de Gesti√≥n</h1>
        <p class="subtitle">Carga masiva de causas desde Excel</p>
        <div class="nav">
            <a href="index.html">üè† Inicio</a>
            <a href="carga.html" class="active">üì§ Carga Masiva</a>
            <a href="consulta.html">üîç Consulta y Edici√≥n</a>
            <a href="admin.html">‚öôÔ∏è Administraci√≥n</a>
        </div>
    </div>

    <div class="card">
        <h2>üìÅ Cargar Causas desde Excel</h2>
        <p>Seleccion√° el archivo Excel con las causas. El sistema detecta autom√°ticamente si hay registros duplicados.</p>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Importante:</strong> Los datos se guardan permanentemente en la base de datos. 
            Pod√©s cargar nuevas causas o actualizar las existentes. Para editar causas ya cargadas, us√° la secci√≥n "Consulta y Edici√≥n".
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <div style="margin-top: 15px;">
            <button id="cargarBtn">üöÄ Cargar Datos</button>
            <button id="vistaPreviaBtn" class="secondary">üëÅÔ∏è Vista Previa</button>
            <button id="verEstadisticasBtn" class="secondary">üìä Ver Estad√≠sticas</button>
        </div>
        
        <div id="mensaje"></div>
        <div id="preview"></div>
    </div>

    <div class="card" id="estadisticasCard" style="display: none;">
        <h3>üìä Estad√≠sticas de la Base de Datos</h3>
        <div id="statsContainer"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jigyfagcxaifgdogaduf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppZ3lmYWdjeGFpZmdkb2dhZHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0OTQ1NDcsImV4cCI6MjA4NzA3MDU0N30.zreu5LPBTgmITGiAGrwEAky6RvIaXjFr3E6sXcK0Olw';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const fileInput = document.getElementById('fileInput');
        const cargarBtn = document.getElementById('cargarBtn');
        const vistaPreviaBtn = document.getElementById('vistaPreviaBtn');
        const verEstadisticasBtn = document.getElementById('verEstadisticasBtn');
        const mensaje = document.getElementById('mensaje');
        const preview = document.getElementById('preview');
        const estadisticasCard = document.getElementById('estadisticasCard');
        const statsContainer = document.getElementById('statsContainer');
        
        let datosExcel = [];
        
        function mostrarMensaje(texto, tipo = 'info') {
            mensaje.innerHTML = `<div class="${tipo}">${texto}</div>`;
        }
        
        function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        function mapearDatos(jsonData) {
            return jsonData.map((row) => {
                const getValor = (nombreExacto, alternativas = []) => {
                    if (row[nombreExacto] !== undefined) return row[nombreExacto];
                    for (let alt of alternativas) {
                        if (row[alt] !== undefined) return row[alt];
                    }
                    const keys = Object.keys(row);
                    for (let key of keys) {
                        if (key.toLowerCase() === nombreExacto.toLowerCase()) {
                            return row[key];
                        }
                    }
                    return null;
                };
                
                return {
                    jud_id: getValor('Jud_id', ['JUD_ID', 'jud_id', 'ID']),
                    expediente: getValor('Expediente', ['EXPEDIENTE', 'expediente']),
                    caratula: getValor('Caratula', ['CARATULA', 'caratula']),
                    nominal: getValor('Nominal', ['NOMINAL', 'nominal']),
                    accesorios: getValor('Accesorios', ['ACCESORIOS', 'accesorios']),
                    multa: getValor('Multa', ['MULTA', 'multa']),
                    obj_id: getValor('Obj_id', ['OBJ_ID', 'obj_id']),
                    tipo_obj: getValor('Tipo_Obj', ['TIPO_OBJ', 'tipo_obj', 'Tipo_obj']),
                    identificador: getValor('Identificador', ['IDENTIFICADOR', 'identificador']),
                    titular: getValor('Titular', ['TITULAR', 'titular']),
                    cuit: getValor('CUIT', ['cuit', 'Cuit']),
                    telefono: getValor('Telefono', ['TELEFONO', 'telefono', 'Tel√©fono', 'TELEF√ìFONO']),
                    mail: getValor('Mail', ['MAIL', 'mail', 'Email', 'EMAIL', 'Correo']),
                    regimen: getValor('Regimen', ['REGIMEN', 'regimen', 'R√©gimen', 'R√âGIMEN']),
                    anio_fab: getValor('Anio_Fab', ['ANIO_FAB', 'anio_fab', 'A√±o_Fab', 'A√ëO_FAB']),
                    valor_rodado: getValor('Valor_Rodado', ['VALOR_RODADO', 'valor_rodado']),
                    causa: getValor('Causa', ['CAUSA', 'causa']),
                    fch_infrac: getValor('FchInfrac', ['FCHINFRAC', 'fchinfrac', 'Fecha_Infrac', 'FECHA_INFRAC']),
                    hora_infrac: getValor('Hora_Infrac', ['HORA_INFRAC', 'hora_infrac', 'Hora']),
                    infraccion: getValor('Infraccion', ['INFRACCION', 'infraccion', 'Infracci√≥n', 'INFRACCI√ìN']),
                    vehiculo: getValor('Vehiculo', ['VEHICULO', 'vehiculo', 'Veh√≠culo', 'VEH√çCULO']),
                    domicilio_postal: getValor('Domicilio_Postal', ['DOMICILIO_POSTAL', 'domicilio_postal']),
                    domicilio_inmueble: getValor('Domicilio_Inmueble', ['DOMICILIO_INMUEBLE', 'domicilio_inmueble']),
                    barrio_inmueble: getValor('Barrio_Inmueble', ['BARRIO_INMUEBLE', 'barrio_inmueble']),
                    domicilio_juzgado: getValor('Domicilio_Juzgado', ['DOMICILIO_JUZGADO', 'domicilio_juzgado']),
                    obs: getValor('Obs', ['OBS', 'obs', 'Observaciones', 'OBSERVACIONES']),
                    carpeta: getValor('Carpeta', ['CARPETA', 'carpeta']),
                    estado: getValor('Estado', ['ESTADO', 'estado']),
                    notas_seguimiento: '',
                    fecha_ultima_actualizacion: new Date().toISOString()
                };
            }).filter(row => row.jud_id);
        }
        
        async function mostrarVistaPrevia() {
            const file = fileInput.files[0];
            if (!file) {
                mostrarMensaje('‚ö†Ô∏è Seleccion√° un archivo primero', 'error');
                return;
            }
            
            try {
                mostrarMensaje('‚è≥ Cargando vista previa...', 'info');
                const jsonData = await leerExcel(file);
                datosExcel = mapearDatos(jsonData);
                
                if (datosExcel.length === 0) {
                    mostrarMensaje('‚ö†Ô∏è No se encontraron datos v√°lidos', 'error');
                    return;
                }
                
                const columnasDetectadas = Object.keys(jsonData[0]);
                let html = `<div class="columnas-encontradas">
                    <strong>üìã Columnas detectadas:</strong> ${columnasDetectadas.join(', ')}<br>
                    <strong>üìä Registros v√°lidos:</strong> ${datosExcel.length}
                </div>`;
                
                html += `<h4>Vista previa (primeras 5 filas):</h4>`;
                html += `<div class="preview"><table>`;
                
                const headers = ['jud_id', 'expediente', 'caratula', 'titular', 'cuit', 'estado'];
                html += '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
                
                datosExcel.slice(0, 5).forEach(row => {
                    const estadoClass = row.estado ? `estado-${row.estado}` : '';
                    html += '<tr>' + headers.map(h => {
                        if (h === 'estado' && row[h]) {
                            return `<td><span class="estado-badge ${estadoClass}">${row[h]}</span></td>`;
                        }
                        return `<td>${row[h] || '-'}</td>`;
                    }).join('') + '</tr>';
                });
                
                html += '</table></div>';
                
                if (datosExcel.length > 5) {
                    html += `<p><em>... y ${datosExcel.length - 5} registros m√°s</em></p>`;
                }
                
                preview.innerHTML = html;
                mostrarMensaje(`‚úÖ Vista previa lista. ${datosExcel.length} registros encontrados.`, 'exito');
                
            } catch (err) {
                mostrarMensaje(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        async function cargarDatos() {
            const file = fileInput.files[0];
            if (!file) {
                mostrarMensaje('‚ö†Ô∏è Seleccion√° un archivo Excel primero', 'error');
                return;
            }
            
            cargarBtn.disabled = true;
            mostrarMensaje('‚è≥ Procesando archivo... <span class="loading"></span>', 'info');
            
            try {
                if (datosExcel.length === 0) {
                    const jsonData = await leerExcel(file);
                    datosExcel = mapearDatos(jsonData);
                }
                
                if (datosExcel.length === 0) {
                    mostrarMensaje('‚ö†Ô∏è No se encontraron datos v√°lidos para cargar', 'error');
                    cargarBtn.disabled = false;
                    return;
                }
                
                mostrarMensaje(`‚è≥ Insertando ${datosExcel.length} registros...<br><small>Esto puede tardar unos segundos...</small> <span class="loading"></span>`, 'info');
                
                const batchSize = 1000;
                let totalInsertados = 0;
                
                for (let i = 0; i < datosExcel.length; i += batchSize) {
                    const batch = datosExcel.slice(i, i + batchSize);
                    
                    const { data, error } = await supabaseClient
                        .from('deudas')
                        .insert(batch)
                        .select();
                    
                    if (error) {
                        throw new Error(`Error en lote ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                    }
                    
                    totalInsertados += data.length;
                    mostrarMensaje(`‚è≥ Insertados ${totalInsertados} de ${datosExcel.length}... <span class="loading"></span>`, 'info');
                }
                
                mostrarMensaje(`‚úÖ ¬°√âXITO! Se cargaron ${totalInsertados} registros.<br>
                <a href="consulta.html" style="color: #155724; font-weight: bold;">Ir a Consulta ‚Üí</a>`, 'exito');
                
                datosExcel = [];
                preview.innerHTML = '';
                fileInput.value = '';
                
            } catch (err) {
                console.error('Error completo:', err);
                mostrarMensaje(`‚ùå Error: ${err.message}`, 'error');
            } finally {
                cargarBtn.disabled = false;
            }
        }
        
        async function verEstadisticas() {
            mostrarMensaje('‚è≥ Cargando estad√≠sticas...', 'info');
            
            try {
                const { data, error } = await supabaseClient
                    .from('deudas')
                    .select('estado');
                
                if (error) throw error;
                
                const total = data.length;
                const porEstado = {};
                data.forEach(d => {
                    const est = d.estado || 'Sin estado';
                    porEstado[est] = (porEstado[est] || 0) + 1;
                });
                
                const nombresEstado = {
                    'X': 'Extrajudicial',
                    'D': 'Con Demanda',
                    'S': 'Con Sentencia',
                    'E': 'Ejecuci√≥n',
                    'C': 'Con Convenio',
                    'P': 'Pagadas'
                };
                
                let html = '<div class="stats">';
                html += `<div class="stat-box"><div class="stat-number">${total}</div><div class="stat-label">Total Causas</div></div>`;
                
                Object.keys(porEstado).sort().forEach(est => {
                    const nombre = nombresEstado[est] || est;
                    const porcentaje = ((porEstado[est] / total) * 100).toFixed(1);
                    html += `<div class="stat-box">
                        <div class="stat-number">${porEstado[est]}</div>
                        <div class="stat-label">${nombre} (${est})<br><small>${porcentaje}%</small></div>
                    </div>`;
                });
                
                html += '</div>';
                statsContainer.innerHTML = html;
                estadisticasCard.style.display = 'block';
                mostrarMensaje('‚úÖ Estad√≠sticas cargadas', 'exito');
                
            } catch (err) {
                mostrarMensaje(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        cargarBtn.addEventListener('click', cargarDatos);
        vistaPreviaBtn.addEventListener('click', mostrarVistaPrevia);
        verEstadisticasBtn.addEventListener('click', verEstadisticas);
        
        fileInput.addEventListener('change', () => {
            preview.innerHTML = '';
            datosExcel = [];
            mostrarMensaje('üìÅ Archivo seleccionado. Pod√©s ver "Vista Previa" o "Cargar Datos".', 'info');
        });
    </script>
</body>
</html>
